<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RR Assistant — Ridgefield Resistance</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,sans-serif;background:#0f0f1a;color:#e5e7eb;height:100vh;display:flex;flex-direction:column;overflow:hidden}
  #header{background:#1a1a2e;border-bottom:1px solid #2d2d44;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
  .logo{width:38px;height:38px;background:#dc2626;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;color:white;flex-shrink:0}
  #header-info{margin-left:12px}
  #header-info h1{font-size:15px;font-weight:600;color:white}
  #header-info p{font-size:12px;color:#6b7280}
  #qlimit{text-align:right}
  #qlimit-text{font-size:12px;font-weight:500;color:#6b7280}
  #qlimit-bar{width:60px;height:4px;background:#374151;border-radius:2px;margin-top:4px;margin-left:auto}
  #qlimit-fill{height:100%;background:#dc2626;border-radius:2px;transition:width 0.3s}
  #messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px}
  .msg{display:flex;align-items:flex-start;gap:8px}
  .msg.user{justify-content:flex-end}
  .msg-avatar{width:30px;height:30px;background:#dc2626;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;color:white;flex-shrink:0;margin-top:2px}
  .bubble{max-width:72%;padding:10px 14px;font-size:14px;line-height:1.6;border-radius:18px;white-space:pre-wrap;word-break:break-word}
  .bubble.assistant{background:#1a1a2e;border:1px solid #2d2d44;color:#e5e7eb;border-radius:18px 18px 18px 4px}
  .bubble.user{background:#dc2626;color:white;border-radius:18px 18px 4px 18px}
  #typing{display:none;align-items:flex-start;gap:8px}
  #typing .bubble{display:flex;gap:5px;align-items:center;padding:12px 16px}
  .dot{width:7px;height:7px;background:#6b7280;border-radius:50%;animation:bounce 1s ease-in-out infinite}
  .dot:nth-child(2){animation-delay:0.15s}
  .dot:nth-child(3){animation-delay:0.3s}
  @keyframes bounce{0%,100%{transform:translateY(0);opacity:0.5}50%{transform:translateY(-4px);opacity:1}}
  #suggestions{padding:0 16px 8px;display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#1a1a2e;border:1px solid #374151;border-radius:20px;padding:6px 12px;color:#9ca3af;font-size:12px;cursor:pointer;transition:all 0.15s;font-family:inherit}
  .chip:hover{border-color:#dc2626;color:#f9fafb}
  #input-area{background:#1a1a2e;border-top:1px solid #2d2d44;padding:12px 16px;flex-shrink:0}
  #input-row{display:flex;gap:8px;align-items:flex-end}
  #msg-input{flex:1;background:#0f0f1a;color:white;border:1px solid #374151;border-radius:12px;padding:11px 14px;font-size:14px;outline:none;resize:none;font-family:inherit;line-height:1.5;min-height:44px;max-height:120px;transition:border-color 0.2s}
  #msg-input:focus{border-color:#dc2626}
  #msg-input::placeholder{color:#4b5563}
  #send-btn{width:44px;height:44px;background:#dc2626;border:none;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.2s}
  #send-btn:hover{background:#b91c1c}
  #send-btn:disabled{background:#374151;cursor:not-allowed}
  #footer-text{color:#374151;font-size:11px;text-align:center;margin-top:8px}
  /* Gate */
  #gate{position:fixed;inset:0;background:#0f0f1a;display:flex;align-items:center;justify-content:center;padding:16px;z-index:100}
  #gate-card{width:100%;max-width:400px}
  #gate-logo{text-align:center;margin-bottom:32px}
  #gate-logo .logo{width:72px;height:72px;font-size:24px;margin:0 auto 16px}
  #gate-logo h1{font-size:24px;font-weight:700;color:white}
  #gate-logo .sub{color:#9ca3af;font-size:14px;margin-top:6px}
  #gate-logo .org{color:#4b5563;font-size:13px;margin-top:4px}
  #gate-inner{background:#1a1a2e;border-radius:16px;padding:24px;border:1px solid #2d2d44}
  #pw-label{color:#d1d5db;font-size:13px;font-weight:600;display:block;margin-bottom:8px}
  #pw-input{width:100%;background:#0f0f1a;color:white;border:2px solid #374151;border-radius:10px;padding:12px 16px;font-size:15px;outline:none;transition:border-color 0.2s;font-family:inherit}
  #pw-input:focus{border-color:#dc2626}
  #pw-err{color:#f87171;font-size:12px;margin-top:8px;display:none}
  #pw-btn{width:100%;margin-top:16px;background:#dc2626;color:white;border:none;border-radius:10px;padding:13px;font-size:15px;font-weight:600;cursor:pointer;transition:background 0.2s;font-family:inherit}
  #pw-btn:hover{background:#b91c1c}
  #gate-hint{color:#4b5563;font-size:12px;text-align:center;margin-top:16px}
  #limit-msg{display:none;text-align:center;padding:8px 0}
  #limit-inner{display:inline-block;background:#1a1a2e;border:1px solid #2d2d44;border-radius:12px;padding:10px 16px;color:#9ca3af;font-size:13px}
  #limit-inner a{color:#f87171}
</style>
</head>
<body>

<!-- PASSPHRASE GATE -->
<div id="gate">
  <div id="gate-card">
    <div id="gate-logo">
      <div class="logo">RR</div>
      <h1 id="g-botname">RR Assistant</h1>
      <p class="sub" id="g-tagline">Your guide to local civic action</p>
      <p class="org" id="g-org">Ridgefield Resistance · Subscriber Access</p>
    </div>
    <div id="gate-inner">
      <label id="pw-label" for="pw-input">Subscriber Passphrase</label>
      <input type="password" id="pw-input" placeholder="Enter your passphrase" autocomplete="off"/>
      <p id="pw-err">Incorrect passphrase. Check this week's newsletter for access.</p>
      <button id="pw-btn">Access RR Assistant →</button>
      <p id="gate-hint">Passphrase included in your weekly newsletter</p>
    </div>
  </div>
</div>

<!-- CHAT UI -->
<div id="header">
  <div style="display:flex;align-items:center">
    <div class="logo">RR</div>
    <div id="header-info">
      <h1 id="h-botname">RR Assistant</h1>
      <p id="h-org">Ridgefield Resistance</p>
    </div>
  </div>
  <div id="qlimit">
    <div id="qlimit-text">10 / 10 questions left</div>
    <div id="qlimit-bar"><div id="qlimit-fill" style="width:100%"></div></div>
  </div>
</div>

<div id="messages">
  <div id="typing">
    <div class="msg-avatar">RR</div>
    <div class="bubble assistant">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
  </div>
</div>

<div id="suggestions" style="display:none">
  <button class="chip" onclick="fillInput('Who is my US Representative?')">Who is my US Representative?</button>
  <button class="chip" onclick="fillInput('What events are coming up?')">What events are coming up?</button>
  <button class="chip" onclick="fillInput('How do I contact my state senator?')">How do I contact my state senator?</button>
  <button class="chip" onclick="fillInput('How do I register to vote?')">How do I register to vote?</button>
</div>

<div id="input-area">
  <div id="input-row">
    <textarea id="msg-input" placeholder="Ask about officials, events, or how to take action..." rows="1"></textarea>
    <button id="send-btn" onclick="sendMsg()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="18" height="18">
        <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/>
      </svg>
    </button>
  </div>
  <p id="footer-text">Ridgefield Resistance · Your guide to local civic action</p>
</div>

<script>
const SHEET_ID = '2PACX-1vTAjCDJgmQZ53MYc9GUh7y43rmLTQMTC3S7-3hj_VH43MBz6YQ1R21Njt7K7RrWPWLnGX8XhBZsQBrO';
const BASE = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub`;
const GIDS = {officials:'0',events:'548359545',faqs:'724535814',resources:'1538934812',config:'1839270458'};

let sheetData = {}, cfg = {}, msgs = [], qCount = 0, maxQ = 10, busy = false;
// Anonymous session ID — refreshes every page load, never stores personal info
const SESSION_ID = 'sess-' + Math.random().toString(36).substring(2, 10);

function csvUrl(gid){ return `${BASE}?gid=${gid}&single=true&output=csv`; }

function parseCSV(text){
  const lines = text.split('\n');
  if(lines.length < 2) return [];
  const headers = splitLine(lines[0]).map(h=>h.replace(/"/g,'').trim());
  return lines.slice(1).filter(l=>l.trim()).map(line=>{
    const vals = splitLine(line);
    const obj={};
    headers.forEach((h,j)=>{ obj[h]=(vals[j]||'').replace(/"/g,'').trim(); });
    return obj;
  });
}

function splitLine(line){
  const res=[];let cur='';let q=false;
  for(let i=0;i<line.length;i++){
    if(line[i]==='"'){q=!q;}
    else if(line[i]===',' && !q){res.push(cur);cur='';}
    else cur+=line[i];
  }
  res.push(cur);return res;
}

async function loadSheets(){
  const entries = await Promise.all(
    Object.entries(GIDS).map(([k,gid])=>
      fetch(csvUrl(gid)).then(r=>r.text()).then(t=>[k,parseCSV(t)]).catch(()=>[k,[]])
    )
  );
  sheetData = Object.fromEntries(entries);
  cfg = {};
  (sheetData.config||[]).forEach(r=>{ if(r.setting_key) cfg[r.setting_key]=r.setting_value; });
  maxQ = parseInt(cfg.max_questions_per_session)||10;

  // Apply config to UI
  const bn = cfg.chatbot_name||'RR Assistant';
  const tl = cfg.chatbot_tagline||'Your guide to local civic action';
  const on = cfg.org_name||'Ridgefield Resistance';
  document.getElementById('g-botname').textContent = bn;
  document.getElementById('g-tagline').textContent = tl;
  document.getElementById('g-org').textContent = on + ' · Subscriber Access';
  document.getElementById('h-botname').textContent = bn;
  document.getElementById('h-org').textContent = on;
  document.getElementById('footer-text').textContent = on + ' · ' + tl;
  updateCounter();
}

function buildSystem(){
  const today = new Date().toISOString().split('T')[0];
  let s = `You are ${cfg.chatbot_name||'RR Assistant'}, a civic information assistant for ${cfg.org_name||'Ridgefield Resistance'} — a grassroots progressive organization based in ${cfg.org_location||'Ridgefield, CT'}.

Your role: Help newsletter subscribers take civic action. Be warm, direct, and specific. Always provide phone numbers, emails, and links when available. Format responses clearly using line breaks between items.

Today's date: ${today}. Never mention events with an expires_date before today.
Geographic scope: ${cfg.geographic_focus||'Ridgefield CT, Fairfield County, Connecticut statewide, Federal CT delegation'}
When curated data doesn't have the answer, search the web for current information.
Out-of-scope: "${cfg.out_of_scope_response||"That's outside my focus area. For broader political questions, I'd recommend checking ProPublica, Ballotpedia, or Congress.gov."}"

=== OFFICIALS ===`;

  (sheetData.officials||[]).filter(o=>o.active!=='FALSE').forEach(o=>{
    if(!o.title) return;
    s+=`\n\n${o.title} ${o.first_name} ${o.last_name} | Level: ${o.level} | District: ${o.district||'N/A'}`;
    if(o.phone) s+=` | Phone: ${o.phone}`;
    if(o.email && o.email!=='via website') s+=` | Email: ${o.email}`;
    if(o.website) s+=` | Website: ${o.website}`;
    if(o.office_address) s+=` | Office: ${o.office_address}`;
    if(o.notes) s+=` | Notes: ${o.notes}`;
  });

  s+='\n\n=== UPCOMING EVENTS ===';
  const upcoming=(sheetData.events||[]).filter(e=>e.active!=='FALSE'&&(e.expires_date||'9999')>=today);
  if(!upcoming.length){s+='\nNo upcoming events.';}
  else upcoming.forEach(e=>{
    s+=`\n\n${e.event_name} (${e.event_type}) — ${e.date} at ${e.time}`;
    s+=` — ${e.location_name}, ${e.location_address}`;
    if(e.description) s+=` — ${e.description}`;
    if(e.registration_link) s+=` — Register: ${e.registration_link}`;
  });

  s+='\n\n=== FAQs ===';
  (sheetData.faqs||[]).forEach(f=>{ if(f.question) s+=`\nQ: ${f.question}\nA: ${f.answer}\n`; });

  s+='\n\n=== RESOURCES ===';
  (sheetData.resources||[]).filter(r=>r.active!=='FALSE').forEach(r=>{
    if(r.name) s+=`\n${r.name} (${r.category}) — ${r.description} — ${r.url}`;
  });

  s+=`\n\n=== ORG CONTACT ===\nEmail: ${cfg.org_email||'N/A'}\nWebsite: ${cfg.org_website||'N/A'}\nSubstack: ${cfg.org_substack||'N/A'}`;
  return s;
}

function updateCounter(){
  const rem = maxQ - qCount;
  document.getElementById('qlimit-text').textContent = `${rem} / ${maxQ} questions left`;
  document.getElementById('qlimit-text').style.color = rem<=3 ? '#f87171' : '#6b7280';
  document.getElementById('qlimit-fill').style.width = `${(rem/maxQ)*100}%`;
  document.getElementById('qlimit-fill').style.background = rem<=3 ? '#ef4444' : '#dc2626';
}

function scrollBottom(){
  const m = document.getElementById('messages');
  m.scrollTop = m.scrollHeight;
}

function addMsg(role, text){
  const container = document.getElementById('messages');
  const typing = document.getElementById('typing');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  if(role==='assistant'){
    div.innerHTML = `<div class="msg-avatar">RR</div><div class="bubble assistant">${text.replace(/\n/g,'<br>')}</div>`;
  } else {
    div.innerHTML = `<div class="bubble user">${text.replace(/</g,'&lt;')}</div>`;
  }
  container.insertBefore(div, typing);
  scrollBottom();
}

function setTyping(show){
  document.getElementById('typing').style.display = show ? 'flex' : 'none';
  scrollBottom();
}

function fillInput(text){
  const inp = document.getElementById('msg-input');
  inp.value = text;
  inp.focus();
  document.getElementById('suggestions').style.display='none';
}

async function sendMsg(){
  if(busy || qCount>=maxQ) return;
  const inp = document.getElementById('msg-input');
  const text = inp.value.trim();
  if(!text) return;
  inp.value=''; inp.style.height='44px';
  document.getElementById('suggestions').style.display='none';

  addMsg('user', text);
  msgs.push({role:'user',content:text});
  busy=true;
  qCount++;
  updateCounter();
  setTyping(true);
  document.getElementById('send-btn').disabled=true;

  try {
    const res = await fetch('/.netlify/functions/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ system: buildSystem(), messages: msgs, session_id: SESSION_ID })
    });
    const data = await res.json();
    const reply = (data.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('')
      || 'I had trouble generating a response. Please try again.';
    msgs.push({role:'assistant',content:reply});
    addMsg('assistant', reply);
  } catch(e) {
    addMsg('assistant','Connection error. Please try again in a moment.');
  } finally {
    busy=false;
    setTyping(false);
    document.getElementById('send-btn').disabled = qCount>=maxQ;
    inp.focus();
  }

  if(qCount>=maxQ){
    const container=document.getElementById('messages');
    const typing=document.getElementById('typing');
    const lim=document.createElement('div');
    lim.style.textAlign='center';lim.style.padding='8px 0';
    lim.innerHTML=`<div style="display:inline-block;background:#1a1a2e;border:1px solid #2d2d44;border-radius:12px;padding:10px 16px;color:#9ca3af;font-size:13px">Session limit reached. Visit <a href="${cfg.org_website||'#'}" style="color:#f87171">${cfg.org_name||'Ridgefield Resistance'}</a> for more resources.</div>`;
    container.insertBefore(lim,typing);
    document.getElementById('msg-input').disabled=true;
    document.getElementById('msg-input').placeholder='Session limit reached';
    scrollBottom();
  }
}

// Input auto-resize
document.getElementById('msg-input').addEventListener('input', function(){
  this.style.height='44px';
  this.style.height=Math.min(this.scrollHeight,120)+'px';
});
document.getElementById('msg-input').addEventListener('keydown', function(e){
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}
});

// Passphrase gate
document.getElementById('pw-input').addEventListener('keydown', e=>{ if(e.key==='Enter') checkPw(); });
document.getElementById('pw-btn').addEventListener('click', checkPw);

function checkPw(){
  const val = document.getElementById('pw-input').value.trim().toUpperCase();
  const correct = (cfg.subscriber_passphrase||'RESISTANCE2026').toUpperCase();
  if(val===correct){
    document.getElementById('gate').style.display='none';
    const welcome = cfg.chatbot_welcome_message||"Hi! I'm the RR Assistant. How can I help you take action today?";
    addMsg('assistant', welcome);
    msgs.push({role:'assistant',content:welcome});
    document.getElementById('suggestions').style.display='flex';
    document.getElementById('msg-input').focus();
  } else {
    const err=document.getElementById('pw-err');
    const inp=document.getElementById('pw-input');
    err.style.display='block';
    inp.style.borderColor='#ef4444';
    setTimeout(()=>{ err.style.display='none'; inp.style.borderColor='#374151'; },3000);
  }
}

// Init
loadSheets();
document.getElementById('pw-input').focus();
</script>
</body>
</html>
